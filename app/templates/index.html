<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°èœœèœ‚å¤§ä¹å ‚</title>


    <link rel="icon" href="static/favicon.png" type="image/x-icon">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
            /* æ›´æŸ”å’Œçš„æµ…ç°èƒŒæ™¯ */
            color: #333;
            /* æ·±ç°æ–‡å­—ï¼Œå¢å¼ºå¯è¯»æ€§ */
        }

        .player-container {
            background-color: #ffffff;
            /* çº¯ç™½å¡ç‰‡ */
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            /* è½»å¾®é˜´å½± */
            border: 1px solid #e0e4e8;
            /* ç»†å¾®è¾¹æ¡† */
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            /* å…è®¸æ¢è¡Œ */
            gap: 10px;
            /* æ§ä»¶ä¹‹é—´çš„é—´è· */
            justify-content: center;
            /* å±…ä¸­æ’åˆ— */
            margin-top: 15px;
        }

        .controls button,
        .controls select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
        }


        button {
            padding: 10px 18px;
            background-color: #5ab9ea;
            /* æŸ”å’Œæ¹–æ°´è“ */
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }


        button:hover {
            background-color: #489fcc;
            /* æ·±ä¸€é˜¶çš„ç‚¹ç¼€è‰² */
        }

        .author-btn {
            background-color: #f29e4c;
            /* æš–æ©™è‰²ä½œä¸ºæ¬¡è¦æ“ä½œè‰² */
        }

        .author-btn:hover {
            background-color: #d3863a;
        }

        .song-info {
            margin: 24px 0;
            padding: 16px;
            background-color: #fafafb;
            /* ææµ…çš„ç°ç™½ */
            border-radius: 6px;
            border: 1px solid #e5e8eb;
        }

        audio {
            width: 100%;
            margin-top: 12px;
        }

        .ripple-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: black;
            z-index: 9997;
            pointer-events: none;
            transition: opacity 0.2s ease, filter 0.2s ease;
        }

        .spectrum-container {
            margin: 24px auto 0 auto;
            max-width: 900px;
            background: linear-gradient(180deg, #ffd8b0, #ffb685, #ff9f6a);
            /* æ¸©æš–æ©™è‰²æ¸å˜ */
            border-radius: 12px;
            padding: 16px;
        }

        #spectrumCanvas {
            display: block;
            width: 100%;
            height: 260px;
            border-radius: 8px;
            background-color: #fff8f0;
        }
    </style>

</head>

<body>
    <div class="player-container">
        <h1>ğŸµ å°èœœèœ‚å¤§ä¹å ‚ ğŸ</h1>

        <div class="song-info">
            <h2 id="current-song">å½“å‰æœªæ’­æ”¾</h2>
            <audio id="audio-player" controls></audio>
        </div>

        <div class="controls">
            <button id="play-btn">éšä¾¿å¬å¬</button>
            <button id="prev-btn">ä¸Šä¸€é¦–</button>
            <button id="toggleSpectrumBtn">æ˜¾ç¤ºé¢‘è°±</button>

            <label for="play-mode"></label><select id="play-mode">
                <option value="random">è¿æ’­æ¨¡å¼ï¼šéšæœºæ’­æ”¾</option>
                <option value="loop-list">è¿æ’­æ¨¡å¼ï¼šåˆ—è¡¨å¾ªç¯</option>
                <option value="single-loop">è¿æ’­æ¨¡å¼ï¼šå•æ›²å¾ªç¯</option>
            </select>

            <label for="folder-selector"></label><select id="folder-selector">
                <option value="dian_gun">æºœå†°å¯†å®¤</option>
                <option value="da_si_ma">èµ·é£åŸºåœ°</option>
                <option value="ding_zhen">çƒŸé›¾ç¼­ç»•</option>
                <option value="dxl">ä¸œæ´‹é›ªè²</option>
                <option value="ha_ji_mi">å“ˆåŸºå’ªå’ª</option>
            </select>

            <button class="author-btn" onclick="window.open('https://github.com/HarvestMoons/HarvestMoons', '_blank')">
                å¼€å‘è€…ä¿¡æ¯
            </button>
        </div>

    </div>

    <!-- ğŸ¨ å•ç‹¬çš„é¢‘è°±å®¹å™¨ -->
    <div class="spectrum-container">
        <canvas id="spectrumCanvas"></canvas>
    </div>

    <script>
        const BACKEND_URL = 'http://8.155.47.138:8081';
        const defaultFolder = 'dian_gun';
        const audioPlayer = document.getElementById('audio-player');
        const currentSongEl = document.getElementById('current-song');
        const playBtn = document.getElementById('play-btn');
        const playModeSelect = document.getElementById('play-mode');
        const folderSelector = document.getElementById('folder-selector');
        const headers = {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Methods': 'POST,PATCH,OPTIONS'
        }

        let playlist = [];  // éšæœºåˆå§‹åŒ–çš„æ’­æ”¾åˆ—è¡¨
        let currentIndex = -1;
        let currentFolder = folderSelector.value;

        folderSelector.addEventListener('change', async () => {
            const selectedFolder = folderSelector.value;
            try {
                const res = await fetch(`${BACKEND_URL}/api/set-folder`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ folder: selectedFolder })
                });
                const result = await res.json();
                if (result.status === 'ok') {
                    currentFolder = selectedFolder;
                    historyStack.length = 0; // <<< æ¸…ç©ºå›é€€å†å²
                    const newList = await fetchSongList();  // é‡æ–°æ‹‰å–æ–°ç›®å½•ä¸‹çš„æ­Œæ›²

                    if (newList.length > 0) {
                        playSongAtIndex(0);
                    } else {
                        currentSongEl.textContent = 'æ— å¯æ’­æ”¾æ­Œæ›²';
                        audioPlayer.src = '';
                    }
                } else {
                    alert('åˆ‡æ¢å¤±è´¥ï¼š' + result.error);
                }
            } catch (e) {
                console.error('åˆ‡æ¢éŸ³ä¹æ–‡ä»¶å¤¹å¤±è´¥', e);
                alert('è¯·æ±‚å¤±è´¥');
            }
        });

        // è·å–æ‰€æœ‰æ­Œæ›²åˆ—è¡¨
        async function fetchSongList() {
            try {
                const res = await fetch(`${BACKEND_URL}/api/songs`);
                const data = await res.json();
                playlist = shuffleArray(data);  // åˆå§‹åŒ–ä¸ºæ‰“ä¹±åçš„åˆ—è¡¨
                historyStack.length = 0; // <<< æ¸…ç©ºå›é€€å†å²
                console.log(playlist[0])
                return playlist;

            } catch (e) {
                console.error("è·å–æ­Œæ›²åˆ—è¡¨å¤±è´¥", e);
                return [];
            }
        }

        // éšæœºæ‰“ä¹±æ•°ç»„
        function shuffleArray(array) {
            return array.slice().sort(() => Math.random() - 0.5);
        }

        window.addEventListener('DOMContentLoaded', async function () {
            // è®¾ç½® currentFolder ä¸ºé»˜è®¤å€¼"dian_gun"
            // å¼ºåˆ¶åˆ‡æ¢åˆ°é»˜è®¤æ–‡ä»¶å¤¹ 'dian_gun'
            // è®¾ç½®é»˜è®¤æ–‡ä»¶å¤¹ä¸º 'dian_gun'
            folderSelector.value = defaultFolder;
            currentFolder = defaultFolder;
            // é€šçŸ¥åç«¯åˆ‡æ¢ç›®å½•
            const res = await fetch(`${BACKEND_URL}/api/set-folder`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ folder: defaultFolder })
            });
            await fetchSongList();

            // è®¾ç½®é»˜è®¤éŸ³é‡ä¸º 30%
            audioPlayer.volume = 0.3;
            const script = document.createElement('script');
            script.src = '/static/js/background-particles.js';
            script.setAttribute('zIndex', '0');
            script.setAttribute('opacity', '0.4');
            script.setAttribute('color', '0,0,0');
            script.setAttribute('count', '99');
            document.body.appendChild(script);
        });

        function parseSongNameWithBv(songName) {
            const name = songName.replace(/\.mp3$/, '');
            const match = name.match(/^(.*?)_?(BV[0-9A-Za-z]+)/);
            if (match) {
                return {
                    title: match[1],
                    bv: match[2]
                };
            }
            return {
                title: name,
                bv: null
            };
        }


        let historyStack = []; // æ’­æ”¾å†å²æ ˆ

        function playSongAtIndex(index, { fromHistory = false } = {}) {
            if (index < 0 || index >= playlist.length) {
                currentSongEl.textContent = 'æ’­æ”¾å¤±è´¥ï¼šç´¢å¼•è¶Šç•Œ';
                return;
            }

            // ä»…å½“ä¸æ˜¯æ¥æºäºå›é€€ï¼Œä¸”ç¡®å®åˆ‡æ¢åˆ°ä¸åŒç´¢å¼•æ—¶æ‰å…¥æ ˆ
            if (!fromHistory && currentIndex !== -1 && currentIndex !== index) {
                historyStack.push(currentIndex);
            }

            currentIndex = index;
            const name = playlist[index];
            audioPlayer.src = `${BACKEND_URL}/music/${encodeURIComponent(currentFolder)}/${encodeURIComponent(name)}`;
            const parsed = parseSongNameWithBv(name);
            if (parsed.bv) {
                currentSongEl.innerHTML = `${parsed.title} <a href="https://www.bilibili.com/video/${parsed.bv}/" target="_blank" style="font-size:14px;color:#007bff;">[å½é‡Œå’•å™œè¯´å•¥å‘¢]</a>`;
            } else {
                currentSongEl.textContent = parsed.title;
            }
            audioPlayer.play();
        }


        function playPreviousSong() {
            if (historyStack.length === 0) {
                alert("æ²¡æœ‰ä¸Šä¸€é¦–äº†ï¼");
                return;
            }
            const prevIndex = historyStack.pop();
            playSongAtIndex(prevIndex, { fromHistory: true });
        }

        document.getElementById('prev-btn').addEventListener('click', playPreviousSong);


        // æ ¹æ®æ’­æ”¾æ¨¡å¼å¤„ç†â€œä¸‹ä¸€é¦–â€
        function handlePlaybackEnd() {
            const mode = playModeSelect.value;
            if (mode === 'single-loop') {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else if (mode === 'loop-list') {
                const nextIndex = (currentIndex + 1) % playlist.length;
                playSongAtIndex(nextIndex);
            } else {
                playRandomSong();
            }
        }

        audioPlayer.addEventListener('error', () => {
            const failedSong = playlist[currentIndex];
            console.warn(`âŒ æ— æ³•æ’­æ”¾ï¼š${decodeURIComponent(failedSong)}ï¼Œå°è¯•ä¸‹ä¸€é¦–(currentIndex:${currentIndex})`);

            setTimeout(() => {
                const mode = playModeSelect.value;
                if (mode === 'loop-list') {
                    const nextIndex = (currentIndex + 1) % playlist.length;
                    playSongAtIndex(nextIndex);
                } else {
                    playRandomSong();
                }
            }, 1000); // å»¶è¿Ÿ 1000 æ¯«ç§’ï¼Œå³ 1 ç§’
        });

        // è·å–å¹¶æ’­æ”¾ä¸€é¦–éšæœºæ­Œæ›²ï¼ˆå‰ç«¯æœ¬åœ°é€‰æ‹©ï¼Œä¸è¯·æ±‚åç«¯ï¼‰
        function playRandomSong() {
            if (!playlist || playlist.length === 0) {
                console.error('æ’­æ”¾å¤±è´¥ï¼šæ­Œæ›²åˆ—è¡¨ä¸ºç©º');
                currentSongEl.textContent = 'æ’­æ”¾å¤±è´¥ï¼šæ­Œæ›²åˆ—è¡¨ä¸ºç©º';
                return;
            }

            const randomIndex = Math.floor(Math.random() * playlist.length);
            playSongAtIndex(randomIndex);
        }

        async function initAndPlay(reload = true) {
            if (reload || playlist.length === 0) {
                const res = await fetch(`${BACKEND_URL}/api/songs`);
                const data = await res.json();
                playlist = shuffleArray(data);
            }
            const randomIndex = Math.floor(Math.random() * playlist.length);
            playSongAtIndex(randomIndex);
        }

        audioPlayer.addEventListener("ended", function () {
            const diff = Math.abs(audioPlayer.currentTime - audioPlayer.duration);

            if (audioPlayer.duration > 0 && diff < 0.5) {
                console.log("éŸ³é¢‘æ’­æ”¾çœŸæ­£å®Œæˆã€‚");
                handlePlaybackEnd();
            } else {
                console.warn("ended äº‹ä»¶è¢«è¯¯è§¦å‘ï¼Œå¿½ç•¥ã€‚");
            }
        });


        playBtn.addEventListener('click', () => {
            const mode = playModeSelect.value;
            if (mode === 'loop-list') {
                initAndPlay(false);  // ä¸æ‰“ä¹±ï¼Œä¿ç•™å½“å‰ playlist
            } else {
                playRandomSong();
            }
        });

        function stopAudio() {
            // åœæ­¢å½“å‰éŸ³ä¹
            if (audioPlayer) {
                audioPlayer.pause();
            }
        }
    </script>
    <script src="/static/js/ripple.js"></script>
    <script src="/static/js/spectrum-visualizer.js"></script>

</body>

</html>